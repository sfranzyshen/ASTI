; PlatformIO Configuration for ArduinoASTInterpreter
;
; v21.1.0: ESP32-S3 Environments - RTTI Default with Opt-In Size Optimization
; =============================================================================
; RTTI (dynamic_cast) is the universal default for all platforms.
; Choose environment based on your requirements:
;   - esp32-s3 (default): RTTI enabled (~906KB binary)
;   - esp32-s3-no-rtti: Size optimization (~866KB binary, -40KB)

[platformio]
default_envs = esp32-s3

; ESP32-S3 Default (RTTI Mode - Runtime Type Safety)
; ===================================================
; Uses dynamic_cast for runtime type verification
; Binary size: ~906KB
;
; ✅ Recommended for:
; • Development and testing
; • When flash space permits (>1MB available)
; • Production deployments prioritizing safety
; • Debugging type cast issues
;
; ⚠️ IMPORTANT: Requires -frtti to override Arduino ESP32's -fno-rtti default
;
; Build: pio run -e esp32-s3
; Upload: pio run -e esp32-s3 -t upload
; Monitor: pio device monitor
[env:esp32-s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; Build flags
build_flags =
    -D ARDUINO_ARCH_ESP32
    -D ESP32
    -D ENABLE_DEBUG_OUTPUT=1
    -D ENABLE_FILE_TRACING=0
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -std=gnu++17
    -frtti                    ; ⚠️ REQUIRED: Override Arduino's -fno-rtti default

; Upload and monitor settings
upload_speed = 921600
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Library configuration
lib_deps =
    ; No external dependencies required

lib_ldf_mode = deep+
lib_extra_dirs =
    src/cpp
    libs/CompactAST/src

; ESP32-S3 specific settings
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L
board_build.mcu = esp32s3
board_build.partitions = default.csv

[env:esp32-s3-debug]
extends = env:esp32-s3
build_type = debug
build_flags =
    ${env:esp32-s3.build_flags}
    -D ENABLE_DEBUG_OUTPUT=1
    -D ENABLE_FILE_TRACING=1
    -g
    -O0

; ESP32-S3 RTTI-Free (Size Optimized - Explicit Opt-In)
; ======================================================
; Uses static_cast with NO runtime checking
; Binary size: ~866KB (-40KB vs RTTI mode)
;
; ⚙️ Recommended for:
; • Production deployments with flash constraints
; • Size-critical applications (<1MB available flash)
; • ONLY after thorough testing with RTTI mode above
;
; ⚠️ WARNING: No runtime type safety - wrong casts cause undefined behavior
;
; Build: pio run -e esp32-s3-no-rtti
; Upload: pio run -e esp32-s3-no-rtti -t upload
; Monitor: pio device monitor
[env:esp32-s3-no-rtti]
extends = env:esp32-s3
build_flags =
    ${env:esp32-s3.build_flags}
    -D AST_NO_RTTI           ; Enable RTTI-free mode (explicit opt-in)
    -fno-rtti                ; Disable RTTI compiler feature
    !-frtti                  ; Remove -frtti from parent environment
