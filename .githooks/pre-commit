#!/bin/bash
#
# Pre-commit hook for ASTInterpreter
# Prevents debug pollution and maintains production code quality
#
# Usage: Copy to .git/hooks/pre-commit and make executable
# Or: git config core.hooksPath .githooks

set -e

echo "ğŸ” Running ASTInterpreter pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
CHECKS_FAILED=0

# Function to report check results
report_check() {
    local check_name="$1"
    local status="$2"
    local details="$3"

    if [ "$status" = "PASS" ]; then
        echo -e "  âœ… ${GREEN}$check_name${NC}"
    else
        echo -e "  âŒ ${RED}$check_name${NC}"
        if [ -n "$details" ]; then
            echo -e "     ${YELLOW}$details${NC}"
        fi
        CHECKS_FAILED=1
    fi
}

# =============================================================================
# CHECK 1: Debug Pollution Detection
# =============================================================================

echo "ğŸ§¹ Checking for debug pollution in production code..."

# Check for std::cout/std::cerr debug statements
DEBUG_PATTERNS=(
    "std::cout.*DEBUG"
    "std::cerr.*ğŸ”§"
    "std::cerr.*ğŸ”"
    "std::cerr.*ğŸš€"
    "std::cerr.*\*\*\*"
    "DEBUG.*ForStatement"
    "DEBUG.*CompoundStmt"
)

STAGED_CPP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp)$' | grep -v test)

if [ -n "$STAGED_CPP_FILES" ]; then
    DEBUG_FOUND=""

    for pattern in "${DEBUG_PATTERNS[@]}"; do
        for file in $STAGED_CPP_FILES; do
            if [ -f "$file" ]; then
                matches=$(git show ":$file" | grep -n "$pattern" || true)
                if [ -n "$matches" ]; then
                    DEBUG_FOUND="$DEBUG_FOUND\n$file: $matches"
                fi
            fi
        done
    done

    if [ -n "$DEBUG_FOUND" ]; then
        report_check "Debug pollution detection" "FAIL" "Found debug statements in production code:$DEBUG_FOUND"
    else
        report_check "Debug pollution detection" "PASS"
    fi
else
    report_check "Debug pollution detection" "PASS" "No C++ files staged"
fi

# =============================================================================
# CHECK 2: Backup File Detection
# =============================================================================

echo "ğŸ—‘ï¸  Checking for backup files..."

BACKUP_PATTERNS=(
    "\.backup$"
    "\.backup_.*$"
    "_backup\."
    "\.orig$"
    "\.old$"
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=A)
BACKUP_FOUND=""

if [ -n "$STAGED_FILES" ]; then
    for pattern in "${BACKUP_PATTERNS[@]}"; do
        matches=$(echo "$STAGED_FILES" | grep -E "$pattern" || true)
        if [ -n "$matches" ]; then
            BACKUP_FOUND="$BACKUP_FOUND\n$matches"
        fi
    done

    if [ -n "$BACKUP_FOUND" ]; then
        report_check "Backup file detection" "FAIL" "Found backup files being added:$BACKUP_FOUND"
    else
        report_check "Backup file detection" "PASS"
    fi
else
    report_check "Backup file detection" "PASS" "No files being added"
fi

# =============================================================================
# CHECK 3: TODO/HACK Detection in Production Code
# =============================================================================

echo "ğŸ“ Checking for TODO/HACK markers in production code..."

TODO_PATTERNS=(
    "TODO.*HACK"
    "TEMPORARY.*WORKAROUND"
    "XXX"
    "FIXME.*URGENT"
)

if [ -n "$STAGED_CPP_FILES" ]; then
    TODO_FOUND=""

    for pattern in "${TODO_PATTERNS[@]}"; do
        for file in $STAGED_CPP_FILES; do
            if [ -f "$file" ]; then
                matches=$(git show ":$file" | grep -n "$pattern" || true)
                if [ -n "$matches" ]; then
                    TODO_FOUND="$TODO_FOUND\n$file: $matches"
                fi
            fi
        done
    done

    if [ -n "$TODO_FOUND" ]; then
        report_check "TODO/HACK detection" "FAIL" "Found urgent TODO/HACK markers:$TODO_FOUND"
    else
        report_check "TODO/HACK detection" "PASS"
    fi
else
    report_check "TODO/HACK detection" "PASS" "No C++ files staged"
fi

# =============================================================================
# CHECK 4: Build Verification
# =============================================================================

echo "ğŸ”¨ Verifying build passes..."

cd build 2>/dev/null || {
    report_check "Build verification" "FAIL" "build/ directory not found"
}

if [ $CHECKS_FAILED -eq 0 ] && [ -d "../build" ]; then
    if make arduino_ast_interpreter >/dev/null 2>&1; then
        report_check "Build verification" "PASS"
    else
        report_check "Build verification" "FAIL" "Build failed after changes"
    fi
else
    report_check "Build verification" "SKIP" "Skipped due to previous failures"
fi

# =============================================================================
# FINAL RESULT
# =============================================================================

echo ""
if [ $CHECKS_FAILED -eq 0 ]; then
    echo -e "ğŸ‰ ${GREEN}All pre-commit checks passed!${NC}"
    echo "âœ… Ready to commit clean, production-ready code"
    exit 0
else
    echo -e "ğŸ’¥ ${RED}Pre-commit checks failed!${NC}"
    echo ""
    echo "ğŸ› ï¸  To fix these issues:"
    echo "   1. Remove debug statements from production code"
    echo "   2. Delete backup files (move to trash/ folder if needed)"
    echo "   3. Address urgent TODO/HACK markers"
    echo "   4. Ensure build passes"
    echo ""
    echo "ğŸš« Commit blocked to maintain code quality"
    exit 1
fi