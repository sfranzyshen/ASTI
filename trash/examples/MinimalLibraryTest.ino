/**
 * MinimalLibraryTest.ino
 *
 * ISOLATION TEST: Tests ArduinoASTInterpreter library ALONE
 * NO parent app, NO CommandExecutor, NO ImmediateCommandExecutor, NO String operations
 *
 * PURPOSE: Determine if memory leak is in the LIBRARY or in parent app processing
 *
 * EXPECTED RESULTS:
 * - If heap drops: Leak is IN THE LIBRARY (interpreter itself)
 * - If heap stable: Leak is IN THE PARENT APP (String operations)
 * - If crashes at ~138: Crash is IN THE LIBRARY
 * - If runs forever: Crash is IN THE PARENT APP
 */

#include <ArduinoASTInterpreter.h>

// ============================================================================
// EMBEDDED MODE AST BINARY - Same as AdvancedInterpreter (Blink.ino)
// ============================================================================

const uint8_t PROGMEM astBinary[] = {
  0x41, 0x53, 0x54, 0x50, 0x00, 0x01, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
  0x3c, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x04, 0x00, 0x76, 0x6f,
  0x69, 0x64, 0x00, 0x05, 0x00, 0x73, 0x65, 0x74, 0x75, 0x70, 0x00, 0x07,
  0x00, 0x70, 0x69, 0x6e, 0x4d, 0x6f, 0x64, 0x65, 0x00, 0x04, 0x00, 0x6c,
  0x6f, 0x6f, 0x70, 0x00, 0x0c, 0x00, 0x64, 0x69, 0x67, 0x69, 0x74, 0x61,
  0x6c, 0x57, 0x72, 0x69, 0x74, 0x65, 0x00, 0x05, 0x00, 0x64, 0x65, 0x6c,
  0x61, 0x79, 0x00, 0x00, 0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x0a, 0x00,
  0x21, 0x01, 0x06, 0x00, 0x02, 0x00, 0x03, 0x00, 0x04, 0x00, 0x50, 0x02,
  0x03, 0x00, 0x0c, 0x00, 0x00, 0x51, 0x02, 0x03, 0x00, 0x0c, 0x01, 0x00,
  0x10, 0x01, 0x02, 0x00, 0x05, 0x00, 0x11, 0x01, 0x02, 0x00, 0x06, 0x00,
  0x33, 0x01, 0x06, 0x00, 0x07, 0x00, 0x08, 0x00, 0x09, 0x00, 0x43, 0x02,
  0x03, 0x00, 0x0c, 0x02, 0x00, 0x40, 0x02, 0x02, 0x00, 0x03, 0x0d, 0x40,
  0x02, 0x02, 0x00, 0x03, 0x01, 0x21, 0x01, 0x06, 0x00, 0x0b, 0x00, 0x0c,
  0x00, 0x0d, 0x00, 0x50, 0x02, 0x03, 0x00, 0x0c, 0x00, 0x00, 0x51, 0x02,
  0x03, 0x00, 0x0c, 0x03, 0x00, 0x10, 0x01, 0x08, 0x00, 0x0e, 0x00, 0x13,
  0x00, 0x17, 0x00, 0x1c, 0x00, 0x11, 0x01, 0x02, 0x00, 0x0f, 0x00, 0x33,
  0x01, 0x06, 0x00, 0x10, 0x00, 0x11, 0x00, 0x12, 0x00, 0x43, 0x02, 0x03,
  0x00, 0x0c, 0x04, 0x00, 0x40, 0x02, 0x02, 0x00, 0x03, 0x0d, 0x40, 0x02,
  0x02, 0x00, 0x03, 0x01, 0x11, 0x01, 0x02, 0x00, 0x14, 0x00, 0x33, 0x01,
  0x04, 0x00, 0x15, 0x00, 0x16, 0x00, 0x43, 0x02, 0x03, 0x00, 0x0c, 0x05,
  0x00, 0x40, 0x02, 0x03, 0x00, 0x05, 0xe8, 0x03, 0x11, 0x01, 0x02, 0x00,
  0x18, 0x00, 0x33, 0x01, 0x06, 0x00, 0x19, 0x00, 0x1a, 0x00, 0x1b, 0x00,
  0x43, 0x02, 0x03, 0x00, 0x0c, 0x04, 0x00, 0x40, 0x02, 0x02, 0x00, 0x03,
  0x0d, 0x40, 0x02, 0x02, 0x00, 0x03, 0x00, 0x11, 0x01, 0x02, 0x00, 0x1d,
  0x00, 0x33, 0x01, 0x04, 0x00, 0x1e, 0x00, 0x1f, 0x00, 0x43, 0x02, 0x03,
  0x00, 0x0c, 0x05, 0x00, 0x40, 0x02, 0x03, 0x00, 0x05, 0xe8, 0x03, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// ============================================================================
// GLOBAL STATE
// ============================================================================

ASTInterpreter* interpreter = nullptr;
unsigned long loopIteration = 0;

// ============================================================================
// SETUP
// ============================================================================

void setup() {
    Serial.begin(115200);
    delay(1000);

    Serial.println("\n\n");
    Serial.println("========================================");
    Serial.println("  MINIMAL LIBRARY ISOLATION TEST");
    Serial.println("========================================");
    Serial.println("Testing ArduinoASTInterpreter library ALONE");
    Serial.println("NO parent app processing");
    Serial.println("NO CommandExecutor");
    Serial.println("NO String operations");
    Serial.println("");
    Serial.println("PURPOSE: Determine if leak is in library or parent app");
    Serial.println("");
    Serial.println("IF heap drops -> Leak is in LIBRARY");
    Serial.println("IF heap stable -> Leak is in PARENT APP");
    Serial.println("IF crashes ~138 -> Crash is in LIBRARY");
    Serial.println("IF runs forever -> Crash is in PARENT APP");
    Serial.println("========================================\n");

    // Configure LED
    pinMode(LED_BUILTIN, OUTPUT);
    digitalWrite(LED_BUILTIN, LOW);

    // Create interpreter
    InterpreterOptions opts;
    opts.verbose = false;  // Don't emit commands to Serial (we're not processing them!)
    opts.debug = false;
    opts.maxLoopIterations = 1;  // One loop iteration per resume()
    opts.syncMode = true;

    Serial.println("Creating interpreter...");
    interpreter = new ASTInterpreter(astBinary, sizeof(astBinary), opts);

    if (!interpreter) {
        Serial.println("ERROR: Failed to create interpreter");
        while(1);
    }

    Serial.println("Starting interpreter...");
    if (!interpreter->start()) {
        Serial.println("ERROR: Failed to start interpreter");
        while(1);
    }

    Serial.println("Interpreter started successfully\n");
    Serial.printf("Initial Free Heap: %d bytes\n", ESP.getFreeHeap());
    Serial.printf("Initial Stack Free: %d bytes\n\n", uxTaskGetStackHighWaterMark(NULL));
    Serial.println("Beginning continuous execution...\n");
}

// ============================================================================
// LOOP
// ============================================================================

void loop() {
    if (interpreter) {
        // Call resume() - NO command processing, just library execution
        interpreter->resume();
        loopIteration++;

        // Memory stats every 10 iterations
        if (loopIteration % 10 == 0) {
            Serial.printf("[%3lu] Heap: %6d bytes | Min: %6d bytes | Stack: %4d bytes\n",
                loopIteration,
                ESP.getFreeHeap(),
                ESP.getMinFreeHeap(),
                uxTaskGetStackHighWaterMark(NULL));
        }

        // Detailed analysis at key iterations
        if (loopIteration == 50 || loopIteration == 100 || loopIteration == 150) {
            Serial.println("\n========== MEMORY ANALYSIS ==========");
            Serial.printf("Iteration: %lu\n", loopIteration);
            Serial.printf("Free Heap: %d bytes\n", ESP.getFreeHeap());
            Serial.printf("Min Free Heap Ever: %d bytes\n", ESP.getMinFreeHeap());
            Serial.printf("Largest Free Block: %d bytes\n", ESP.getMaxAllocHeap());
            Serial.printf("Heap Size: %d bytes\n", ESP.getHeapSize());
            Serial.printf("Stack Free: %d bytes\n\n", uxTaskGetStackHighWaterMark(NULL));

            // Heap fragmentation analysis
            multi_heap_info_t info;
            heap_caps_get_info(&info, MALLOC_CAP_DEFAULT);
            Serial.println("Fragmentation Analysis:");
            Serial.printf("  Total Free: %d bytes\n", info.total_free_bytes);
            Serial.printf("  Largest Block: %d bytes\n", info.largest_free_block);
            Serial.printf("  Allocated Blocks: %d\n", info.allocated_blocks);
            Serial.printf("  Free Blocks: %d\n", info.free_blocks);
            Serial.printf("  Total Allocated: %d bytes\n", info.total_allocated_bytes);

            float fragPercent = 100.0 * (1.0 - ((float)info.largest_free_block / (float)info.total_free_bytes));
            Serial.printf("  Fragmentation: %.1f%%\n", fragPercent);

            if (fragPercent > 50.0) {
                Serial.println("  *** WARNING: HIGH FRAGMENTATION DETECTED! ***");
            }

            Serial.println("=====================================\n");
        }
    }

    delay(1);  // Yield to watchdog
}
